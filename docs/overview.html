<!DOCTYPE html>

<html>
<head>
  <title>Post Commit</title>
  <link href="search/tipuesearch.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>

<body class="page--overview">
<header>
  <div class="pager">
  <a href="README.html" class="prev README">&laquo;Post Commit</a>
  <a href="index.html" class="index">Index</a>
  <a href="index.html" class="next index">Index&raquo;</a>
</div>
</header>

  <div class="search__wrapper">
  <form action="search--results.html">
    <input type="text" class="search-input" name="q" id="tipue_search_input" autocomplete="off" required>
  </form>
</div>

  <h1>Post Commit</h1>
  <div class="breadcrumb"><a href="index.html">Index</a></div>

<section>

<p>A solution to take the post commit hook from github.com and schedule, then pull that repository into your public facing website, most noteably without compromising security by giving ownership of your web files to the apache user, but scheduling cron jobs to be run by a privilaged user instead.</p>

<h2>Quick Start</h2>

<pre><code>[ -d opt ] || mkdir opt
[ -d bin ] || mkdir bin
[ -d bin/config ] || mkdir bin/config
cd opt &amp;&amp; git clone git@github.com:aklump/post_commit.git
cp opt/post_commit/git_pull.example.sh bin/git_pull.sh
cp opt/post_commit/config.default.php bin/config/post_scheduler.php
</code></pre>

<h2>Installation</h2>

<ol>
<li>Create a folder one level above web root called <code>opt</code> and save this package therein <code>opt/post_commit</code> (or wherever appropriate ABOVE web root).  E.g., <code>mkdir opt &amp;&amp; cd opt &amp;&amp;  git clone git@github.com:aklump/post_commit.git</code></li>
<li>First create a script at <em>bin/git_pull.sh</em> that will do a git pull against your origin repo; this will be used by Post Commit.  For an example take a look at <code>git_pull.example.sh</code>.  Test the script and make sure it is working correctly.  It is not possible to use a passphrase on your deploy key at this time.</li>
<li><p>Navigate to your webroot and create a symlink to <code>opt/post_commit/scheduler.php</code>: something like this:</p>

<pre><code>ln -s ../opt/post_commit/scheduler.php .
</code></pre></li>
<li><p>Copy <code>post_commit/config.default.php</code> to <code>post_commit/config.php</code></p></li>
<li>Make adjustements to <code>config.php</code>.</li>
<li>Create a dir called <code>opt/post_commit/logs</code>.</li>
<li><p>Create each of these files inside of <code>opt/post_commit/logs</code>:</p>

<pre><code>touch complete.txt orders.txt pending.txt cron.txt
</code></pre></li>
<li><p>Set the correct ownership and permissions on <em>opt/post_commit/logs</em>; they must be owned by the user that will run cron and the group must be the php user (you can see this by visiting the testing url per directions below) who will be executing <em>scheduler.php</em>.  Owner/Group privelages must be both RW.  Other needs no permissions.</p>

<pre><code>drwxr-xr-x 2 aklump apache 4.0K May 28 17:02 .
drwxr-xr-x 5 aklump staff  4.0K May 28 17:01 ..
-rw-rw---- 1 aklump apache    0 May 28 17:16 complete.txt
-rw-rw---- 1 aklump apache    0 May 28 17:16 orders.txt
-rw-rw---- 1 aklump apache    0 May 28 17:16 pending.txt      
</code></pre></li>
<li><p>Set up a cron job to execute <code>runner.php</code> (see below).</p></li>
<li><p>Compile the post commit hook url and add it to your github project.  Keep the key in the url, do not use the secret textfield.  Also you will want to choose the json format.  Make sure to use https if you can, a self-signed cert should work fine.</p>

<pre><code>https://user:password@website.com/scheduler.php?key=yourprivatekeyhere
</code></pre></li>
<li><p>Now make a commit to your repo and the website should update itself.</p></li>
</ol>

<h2>scheduler.php</h2>

<p>This should be pinged by a post commit hook on the origin repo via https and including the secret key.</p>

<h3>Testing</h3>

<ol>
<li>Place the url you've created in a browser and look for output.</li>
<li>If the screen is white, look in your server error logs.</li>
</ol>

<p>You can test a single repository by appending the following to the url, for the purposes of testing.</p>

<pre><code>&amp;repo=jquery.slim_time
</code></pre>

<p>You can trigger a single branch response by appending the following to the url, for the purposes of testing.</p>

<pre><code>&amp;branch=master
</code></pre>

<h2>runner.php</h2>

<p>This should be the target of a frequent cron job being run by the same user that owns the website files and <em>.git</em> folder.  This script processes any orders that were scheduled by <em>scheduler.php</em>.  You can redirect the output to <code>logs/cron.txt</code> file during setup, and once all is working you should consider doing like the second example which does not capture the output.</p>

<pre><code>* * * * * /usr/bin/php /home/user/mysite/opt/post_commit/runner.php &gt;&gt; /home/user/mysite/opt/post_commit/logs/cron.txt
</code></pre>

<p>Example 2, no log of cron jobs, better once all is working correctly.  You might want to delete <code>logs/cron.txt</code> at this point.</p>

<pre><code>* * * * * /usr/bin/php /home/user/mysite/opt/post_commit/runner.php &gt; /dev/null
</code></pre>

<h2>orders.txt</h2>

<p><strong>You can truncate all text files without messing up perms using <em>reset.php</em>.</strong></p>

<p>A log of incoming orders post commit hooks.</p>

<h2>complete.txt</h2>

<p>A log of <em>runner.php</em>.</p>

<h2>pending.txt</h2>

<p>The commands that have not yet been executed by cron.  This file should get emptied at each cron run.</p>

<h2>To dump all logs and cancel standing orders</h2>

<p>Don't just delete the log files as permissions are bit tricky; instead use the reset script.</p>

<pre><code>php reset.php
</code></pre>

<h2>Troubleshooting</h2>

<h3>Jobs get scheduled but not run?</h3>

<ol>
<li><p>Check to make sure the the logs directory and all log files are owned by the cron user and the group is the php user and that both user and group has rw permissions.</p></li>
<li><p>Does the git repo require a passphrase for pulling?  You will have to disable that.</p></li>
<li><p>Try logging in to the server as the cron user and running the command.</p></li>
<li><p>Make sure you can git pull manually using your ssh keys, etc.</p></li>
</ol>
</section>

<div class="search__results">
  <div id="tipue_search_content"></div>
</div>

<footer>
  <div class="pager">
  <a href="README.html" class="prev README">&laquo;Post Commit</a>
  <a href="index.html" class="index">Index</a>
  <a href="index.html" class="next index">Index&raquo;</a>
</div>
  
  <div id="footer-legaleeze">
    <p class="legaleeze center">Version: 0.4.15 &bull; Last Updated: Mon, 29 Oct 2018 11:46:14 -0700</p>
  </div>
</footer>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="search/tipuesearch_content.js"></script>
  <script src="search/tipuesearch_set.js"></script>
  <script src="search/tipuesearch.min.js"></script>
  <script>
    $(document).ready(function () {
      $('#tipue_search_input').tipuesearch();
    });
  </script>
<script src="js/core.js"></script>
</body>
</html>

